<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet" />
    <link th:href="@{/layui/css/view.css}" rel="stylesheet" />
    <script th:src="@{/layui/layui.all.js}"></script>
    <script th:src="@{/jquery/jquery-2.1.4.min.js}"></script>
    <title></title>
</head>
<body class="layui-view-body">
<div class="layui-row">
    <div class="layui-card">
        <form class="layui-form layui-card-body layui-form-pane" method="post" th:action="@{/app/env/config/save}">
            <div class="layui-form-item">
            <!--    <div class="layui-inline">
                    <div class="layui-form-mid">docker配置文件端口</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="number" name="dockerPort" id="dockerPort" th:value="${config.dockerPort}"  placeholder="2375"   autocomplete="off" class="layui-input">
                    </div>
                </div>-->
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>harbor 仓库配置</legend>
                </fieldset>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">地址</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="harborUrl" id="harborUrl" lay-verify="required"  th:value="${config.harborUrl}" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">用户名</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="harborUser" id="harborUser" lay-verify="required" th:value="${config.harborUser}" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">用户密码</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="harborPassword" id="harborPassword" lay-verify="required"  th:value="${config.harborPassword}" autocomplete="off" class="layui-input">
                    </div>
                </div>

            </div>

            <div class="layui-form-item">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>镜像配置</legend>
                </fieldset>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">仓库地址</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="harborImagePrefix" id="harborImagePrefix" lay-verify="required"  th:value="${config.harborImagePrefix}" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">项目镜像前缀</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="harborImageProjectName" id="harborImageProjectName" lay-verify="required"  th:value="${config.harborImageProjectName}" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">环境镜像前缘</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="harborImageEnvProjectName" id="harborImageEnvProjectName" lay-verify="required"  th:value="${config.harborImageEnvProjectName}" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>NFS配置</legend>
                </fieldset>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">NFS名称</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="nfsStorageClassName" id="nfsStorageClassName" lay-verify="required"  th:value="${config.nfsStorageClassName}" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 205px">Mysql 存储大小(G)</div>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input  type="number" name="nfsMySqlStorageSize"th:min="2" th:max="100" id="nfsMySqlStorageSize"lay-verify="required"  th:value="${config.nfsMySqlStorageSize}"  placeholder="2"   autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 205px">nacos 存储大小(G)</div>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input  type="number" name="nfsNacosStorageSize" th:min="2" th:max="100"id="nfsNacosStorageSize"lay-verify="required"  th:value="${config.nfsNacosStorageSize}"  placeholder="2"   autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 205px">Rabbitmq  存储大小(G)</div>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input  type="number" name="nfsMqStorageSize"  th:min="2" th:max="100"id="nfsMqStorageSize"lay-verify="required"  th:value="${config.nfsMqStorageSize}"  placeholder="2"   autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 205px">fdfs  存储大小(G)</div>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input  type="number" name="nfsFdfsStorageSize"th:min="2" th:max="1000" id="nfsFdfsStorageSize"lay-verify="required"  th:value="${config.nfsFdfsStorageSize}"  placeholder="2"   autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 205px">neo4j  存储大小(G)</div>
                    <div class="layui-input-inline" style="width: 100px;">
                        <input  type="number" name="nfsNeo4jStorageSize"th:min="2" th:max="500" id="nfsNeo4jStorageSize"lay-verify="required"  th:value="${config.nfsNeo4jStorageSize}"  placeholder="2"   autocomplete="off" class="layui-input">
                    </div>
                </div>

            </div>

            <div class="layui-form-item">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>python依赖 多个用 , 隔开</legend>
                </fieldset>
                <div class="layui-form-item">
                    <label class="layui-form-label">python依赖 Flask,py2neo==2021.1.1,jieba,sklearn,gunicorn,gevent,xlrd==1.2.0</label>
                    <div class="layui-input-block">
                        <input type="text" name="pythonRely" id="pythonRely"  th:value="${config.pythonRely}"  autocomplete="off" placeholder="请输入标题" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>集群--可空</legend>
                </fieldset>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">集群外网</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input type="text" name="bindK8sIP" id="bindK8sIP"  th:value="${config.bindK8sIP}"  autocomplete="off" placeholder="可为空" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 150px">检查群集主节点端口</label>
                    <div class="layui-input-block">
                        <input type="text" name="k8sNetPort" style="width: 80%" id="k8sNetPort"  th:value="${config.k8sNetPort}"  autocomplete="off" placeholder="主节点端口" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 150px">检查群集子节点端口</label>
                    <div class="layui-input-block">
                        <input type="text" name="k8sNetNodePort" style="width: 80%" id="k8sNetNodePort"  th:value="${config.k8sNetNodePort}"  autocomplete="off" placeholder="节点端口" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 150px">nfs检查IP</label>
                    <div class="layui-input-inline">
                        <input type="text" name="checkNfsIp" id="checkNfsIp"  th:value="${config.checkNfsIp}"  autocomplete="off" placeholder="nfsIp" class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 150px">harbor检查IP</label>
                    <div class="layui-input-inline">
                        <input type="text" name="checkHarborIp" id="checkHarborIp"  th:value="${config.checkHarborIp}"  autocomplete="off" placeholder="nfsIp" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>邮箱配置---可空</legend>
                </fieldset>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">邮箱地址</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="mailHost" id="mailHost"  th:value="${config.mailHost}" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">邮箱端口</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="number" name="mailPort" id="mailPort"  th:value="${config.mailPort}" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">邮箱用户名</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="mailUser" id="mailUser"  th:value="${config.mailUser}" autocomplete="off" class="layui-input">
                    </div>
                </div>


                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">邮箱密码</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="password" name="mailPass" id="mailPass"  th:value="${config.mailPass}" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 125px">邮箱主题</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input  type="text" name="mailSubject" id="mailSubject"   th:value="${config.mailSubject}" placeholder="写学院名称" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <button type="button" id="testMail" class="layui-btn" >测试邮箱</button>
                    <button type="button" id="testMailSuccess" style="display:none" class="layui-btn layui-btn-xs">成功</button>
                    <button type="button" id="testMailFail" style="display:none" class="layui-btn layui-btn-xs layui-btn-danger">验证失败</button>
                    <button type="button" id="testMailCheck" style="display:none" class="layui-btn layui-btn-xs layui-btn-warm">验证中……</button>

                </div>
                <input hidden id="mailPersons" th:value="${config.mailPerson}" />
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">故障时发送邮箱，多个用英文逗号,隔开</label>
                    <div class="layui-input-block">
                        <textarea name="mailPerson" id="mailPerson"  placeholder="请输入邮箱"  class="layui-textarea"></textarea>
                    </div>
                </div>

                <!--      <div class=" ">
                          <button  type="button" class="addMail layui-btn layui-btn-normal layui-btn-sm" id="addMail">添加邮件</button>
                      </div>

                      <div id="mailDiv">
      -->

            </div>



            <div class="layui-form-item">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>默认命名空间</legend>
                </fieldset>
                <div class="layui-inline">
                    <div class="layui-form-label" style="width: 180px;">默认命名空间</div>
                    <div class="layui-input-inline" style="width: 180px;">
                        <input id="defaultNamespaceHidden" hidden th:value="${config.defaultNamespace}"/>
                        <select id="defaultNamespace" th:value="${config.defaultNamespace}" name="defaultNamespace">
                            <option value="">请选择</option>
                        </select>
                    </div>
                </div>

            </div>
            <div class="layui-form-item">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px; color: mediumaquamarine">
                    <legend>docker配置</legend>
                </fieldset>
                   <div class="layui-inline">
                        <div class="layui-form-label">docker 端口</div>
                        <div class="layui-input-inline" style="width: 180px;">
                            <input  type="number" name="dockerPort" id="dockerPort"lay-verify="required"  th:value="${config.dockerPort}"  placeholder="2375"   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                <div class="layui-form-item">
                    <button type="submit" class="layui-btn" lay-submit lay-filter="*">保存</button>
                    <button type="button" class="layui-btn layui-btn-danger" id="restart">重置</button>
                    <button type="button" class="layui-btn layui-btn-danger" id="deleteImageDir">清空异常镜像</button>
                </div>
            </div>

        </form>


    </div>
</div>
</body>


<script>
var element = layui.element;
var table = layui.table;
var layer = layui.layer;
var form = layui.form;
var mailIndex = 0;
var $ = layui.jquery

$("#mailPerson").val($("#mailPersons").val())


$.ajax({
    url : "[[@{/}]]deploy/getNamespace",
    type : "get",
    dataType : "json",
    error : function(data) {
        errorHandle(data);
    },
    success : function(data) {
        $.each(data, function (index, item) {
            $('#defaultNamespace').append(new Option(item.name, item.name));// 下拉菜单里添加元素
            var val = $("#defaultNamespaceHidden").val();
            if (val && item.name == val ){
              $('#defaultNamespace').val(item.name)
            }

        });
        layui.form.render("select")
    }
});
//表单取值
layui.$('#restart').on('click', function(){
    layer.confirm("确认重置吗？", {icon: 3, title:'提示'}, function(index) {
        layer.close(index);
        $.ajax({
            url : "[[@{/}]]app/env/config/restart",
            type : "post",
            dataType : "json",
            error : function(data) {
                errorHandle(data);
            },
            success : function(data) {
                data=data.data
                layer.msg('重置成功');
                $("#harborUrl").val(data.harborUrl)
                $("#harborUser").val(data.harborUser)
                $("#harborPassword").val(data.harborPassword)
                $("#harborImagePrefix").val(data.harborImagePrefix)
                $("#harborImageProjectName").val(data.harborImageProjectName)
                $("#harborImageEnvProjectName").val(data.harborImageEnvProjectName)
                $("#nfsStorageClassName").val(data.nfsStorageClassName)
                $("#nfsMySqlStorageSize").val(data.nfsMySqlStorageSize)
                $("#nfsNacosStorageSize").val(data.nfsNacosStorageSize)
                $("#nfsMqStorageSize").val(data.nfsMqStorageSize)
                $("#nfsFdfsStorageSize").val(data.nfsFdfsStorageSize)
                $("#nfsNeo4jStorageSize").val(data.nfsNeo4jStorageSize)
                $("#dockerPort").val(data.dockerPort)
                $("#pythonRely").val(data.pythonRely)
              console.log(data)
              console.log(data.harborImageEnvProjectName)

            }
        });
    });


});

layui.$('#deleteImageDir').on('click', function(){
        $.ajax({
            url : "[[@{/}]]harbor/deleteImageDir",
            type : "post",
            dataType : "json",
            error : function(data) {
                errorHandle(data);
            },
            success : function(data) {
                layer.msg('清空完成');
            }
        });
});
//测试邮件
layui.$('#testMail').on('click', function(){
       var mailPass = $("#mailPass").val();
       var mailUser = $("#mailUser").val();
       var mailPort = $("#mailPort").val();
       var mailHost = $("#mailHost").val();
       var mailSubject = $("#mailSubject").val();
       var mailPerson = $("#mailPerson").val();
      var data={mailPass:mailPass,
          mailUser:mailUser,
          mailPort:mailPort,
          mailHost:mailHost,
          mailSubject:mailSubject,
          mailPerson:mailPerson,
      }
       $("#testMailCheck").show()
       $("#testMailFail").hide()
       $("#testMailSuccess").hide()
        $.ajax({
            url : "[[@{/}]]mail/test",
            type : "post",
            data:data,
            dataType : "json",
            error : function(data) {
                errorHandle(data);
            },
            success : function(data) {
                if (data.code == 200){
                    layer.msg('已发送……请查收');
                    $("#testMailSuccess").show()
                    $("#testMailFail").hide()
                    $("#testMailCheck").hide()
                }else{
                    layer.msg(data.msg, {icon: 2});
                    $("#testMailFail").show()
                    $("#testMailSuccess").hide()
                    $("#testMailCheck").hide()
                }
            }
        });
});


// 按钮事件


// 提交表单
form.on('submit(*)', function(data){
    layer.confirm("确认提交吗？", {icon: 3, title: '提示'}, function (index) {
        layer.close(index);
        $(".layui-form").ajaxForm({
            error: function (data) {
                errorHandle(data);
            },
            success: function (data) {
                if (data.code == 200) {
                    //parent.location.reload();
                    // var index = parent.layer.getFrameIndex(window.name);
                    // parent.layer.close(index);
                    layer.msg("成功", {icon: 2});
                } else {
                    console.log("data404", data)
                    layer.msg(data.msg, {icon: 2});
                }
            }
        });
    })
});
//添加
$("form").on('click','.addMail', function(){
    var html="";
    //mailDiv
    mailIndex++
    console.log("555")
    html+='<div class="layui-inline " style="width: 330px">'
    html +='<div class="layui-form-label" style="width: 100px">邮箱'+mailIndex+'</div>'
    html +='<div class="layui-input-inline" style="width: 180px;">'
    html+='  <input  type="text"  id="add_mail_'+mailIndex+'"  th:value="${config.mailPass}" autocomplete="off" class="layui-input">'

    html+='  </div>'

    html+='<div>';
    html+=' <input type="button" id="del_mail_'+mailIndex+'" class="del_mail layui-btn layui-btn-danger layui-btn-xs" value="删除">';
    // taskHtml+='<button  type="button" class="del_env_'+i+' layui-btn layui-btn-normal layui-btn-sm" value="删除" id="addEnv">';
    html+='</div>';
    html+='  </div>'
   $("#mailDiv").append(html);
});
//删除
$('form').on("click",".del_mail",function(){
    $(this).parent().parent().remove();
    return false;
});

//错误处理
function errorHandle(data) {
	if (data.status == 404) {
		layer.msg("请求资源不存在", {icon: 2});
	} else {
		layer.msg("服务端异常", {icon: 2});
	}
	return;
}
</script>
</html>